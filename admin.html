<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Google Fonts for that clean SaaS look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- SILICON VALLEY AESTHETIC (Internal Styles to guarantee the look) --- */
        :root {
            --primary: #4F46E5; /* Indigo-600 */
            --primary-hover: #4338ca;
            --bg-body: #F3F4F6; /* Cool Gray */
            --bg-card: #FFFFFF;
            --text-main: #111827;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --danger: #EF4444;
            --success: #10B981;
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
        }

        /* Login Screen */
        #login-screen {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        }

        /* Layout */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #1F2937; /* Dark Slate */
            color: white;
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            color: #F9FAFB;
            font-weight: 600;
            letter-spacing: 0.025em;
        }

        .sidebar button {
            background: transparent;
            border: none;
            color: #9CA3AF;
            padding: 12px 15px;
            text-align: left;
            width: 100%;
            cursor: pointer;
            border-radius: var(--radius);
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 5px;
        }

        .sidebar button:hover {
            background: #374151;
            color: white;
        }

        .sidebar button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4);
        }

        .content {
            flex-grow: 1;
            padding: 40px;
            overflow-y: auto;
        }

        /* Cards & Forms */
        .tab-content h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-main);
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .section-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        input[type="text"], input[type="number"], input[type="file"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box; /* Important fix */
        }
        
        textarea { resize: vertical; min-height: 100px; }

        input:focus {
            border-color: var(--primary);
            ring: 2px solid var(--primary);
        }

        /* Style Controls Row */
        .style-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .style-controls select, .style-controls input {
            flex: 1;
        }

        /* Buttons */
        .btn {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
        }
        .btn:hover { background-color: var(--primary-hover); }
        .btn:active { transform: scale(0.98); }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); font-size: 0.8rem; padding: 6px 12px;}
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }

        /* Image Previews */
        .preview-container {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border);
            border-radius: var(--radius);
            background: #fafafa;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 60px;
        }
        .preview-img {
            height: 60px;
            width: auto;
            border-radius: 4px;
            box-shadow: var(--shadow);
        }
        
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .hero-item {
            position: relative;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .hero-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            display: block;
        }
        .delete-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--danger);
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Utilities */
        .hidden { display: none !important; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); display:flex; flex-direction:column; }
        .card img { width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; }
        .review-card { padding: 15px; margin-bottom: 10px; border-radius: var(--radius); border: 1px solid var(--border); }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .toggle-switch {
            position: relative; width: 50px; height: 26px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* Order List */
        .order-row {
            background: white; border: 1px solid var(--border); border-radius: 8px;
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .order-row:hover { box-shadow: var(--shadow); }

        @media (max-width: 768px) {
            .admin-container { flex-direction: column; }
            .sidebar { width: 100%; padding: 10px; }
            .content { padding: 15px; }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%;">
            <h1 style="margin-bottom: 10px; color: var(--text-main);">Admin Portal</h1>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Manage your PWA securely.</p>
            <button id="login-btn" class="btn" style="width: 100%;">Login with Gmail</button>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="admin-container hidden">
        <div class="sidebar">
            <h2>üõçÔ∏è E-Comm Admin</h2>
            <button onclick="showTab('tab1')" class="active">‚öôÔ∏è General Settings</button>
            <button onclick="showTab('tab6')">üì¶ New Orders</button>
            <button onclick="showTab('tab2')">‚ûï Add/Edit Product</button>
            <button onclick="showTab('tab3')">üìã All Products</button>
            <button onclick="showTab('tab4')">‚≠ê Reviews</button>
            <button onclick="showTab('tab5')">üìû Contact Info</button>
            <button onclick="logout()" style="margin-top: auto; color: #ff6b6b; border: 1px solid #ff6b6b;">Log Out</button>
        </div>

        <div class="content">
            
            <!-- Tab 1: General Settings -->
            <div id="tab1" class="tab-content">
                <h2>General Settings</h2>
                
                <!-- Website Name Configuration -->
                <div class="section-card">
                    <label>1. Website Name Configuration</label>
                    <input type="text" id="webNameInput" placeholder="Enter Website Name (e.g. MyStore)">
                    <div class="style-controls">
                        <select id="webNameFont">
                            <option value="Poppins, sans-serif">Poppins</option>
                            <option value="Inter, sans-serif">Inter</option>
                            <option value="'Courier New', monospace">Courier</option>
                            <option value="serif">Serif</option>
                        </select>
                        <input type="number" id="webNameSize" placeholder="Size (px)" value="24">
                        <input type="color" id="webNameColor" value="#000000" style="height: 42px; padding: 2px;">
                    </div>
                </div>

                <!-- Slogan Configuration -->
                <div class="section-card">
                    <label>2. Slogan Configuration</label>
                    <input type="text" id="sloganInput" placeholder="Enter Slogan">
                    <div class="style-controls">
                        <select id="sloganFont">
                            <option value="Poppins, sans-serif">Poppins</option>
                            <option value="Inter, sans-serif">Inter</option>
                            <option value="cursive">Cursive</option>
                        </select>
                        <input type="number" id="sloganSize" placeholder="Size (px)" value="16">
                        <input type="color" id="sloganColor" value="#666666" style="height: 42px; padding: 2px;">
                    </div>
                </div>

                <!-- Logo -->
                <div class="section-card">
                    <label>3. Website Logo</label>
                    <div style="display:flex; gap:10px;">
                        <input type="file" id="logoUpload">
                        <button class="btn" onclick="uploadAsset('logo')">Upload</button>
                    </div>
                    <div id="logoPreviewArea" class="preview-container hidden">
                        <img id="logoPreviewImg" class="preview-img" src="" alt="Logo">
                        <button class="btn btn-danger" onclick="deleteAsset('logo')">Delete</button>
                    </div>
                </div>

                <!-- Favicon -->
                <div class="section-card">
                    <label>4. Favicon</label>
                    <div style="display:flex; gap:10px;">
                        <input type="file" id="faviconUpload">
                        <button class="btn" onclick="uploadAsset('favicon')">Upload</button>
                    </div>
                    <div id="faviconPreviewArea" class="preview-container hidden">
                        <img id="faviconPreviewImg" class="preview-img" src="" alt="Favicon">
                        <button class="btn btn-danger" onclick="deleteAsset('favicon')">Delete</button>
                    </div>
                </div>

                <!-- Hero Images -->
                <div class="section-card">
                    <label>5. Hero Images (Max 5)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="file" id="heroUpload" multiple>
                        <button class="btn" onclick="uploadHeroImages()">Upload New</button>
                    </div>
                    <div id="heroList" class="hero-grid">
                        <!-- Hero Images Rendered Here -->
                    </div>
                </div>

                <div style="text-align: right;">
                    <button class="btn btn-success" style="padding: 15px 30px; font-size: 1.1rem;" onclick="saveGeneralSettings()">üíæ Save All Settings</button>
                </div>
            </div>

            <!-- Tab 2: Add Product (UPDATED) -->
            <div id="tab2" class="tab-content hidden">
                <h2 id="tab2Title">Add New Product</h2>
                <input type="hidden" id="editProductId"> <!-- Hidden field for edit ID -->
                
                <div class="section-card">
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="prodName">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Price (Rs.)</label>
                            <input type="number" id="prodPrice">
                        </div>
                        <div class="form-group">
                            <label>Button Label (Home Card)</label>
                            <input type="text" id="prodBtnLabel" value="See More">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Product Slug (Unique URL Identifier, e.g. blue-shoes-01)</label>
                        <input type="text" id="prodSlug" placeholder="my-awesome-product">
                    </div>

                    <div class="form-group">
                        <label>Product Description</label>
                        <textarea id="prodDesc" placeholder="Full details about the product..."></textarea>
                    </div>

                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="prodStock" checked>
                            <span class="slider"></span>
                        </label>
                        <span>In Stock (Green Badge)</span>
                    </div>

                    <div class="form-group">
                        <label>Product Images (Max 5)</label>
                        <input type="file" id="prodImages" multiple>
                        <small style="color:var(--text-muted)">Select multiple files at once. Top one is main image.</small>
                        <div id="editImagePreview" class="hero-grid"></div>
                    </div>

                    <button id="saveProductBtn" class="btn btn-success" onclick="saveProduct()">Publish Product</button>
                    <button id="cancelEditBtn" class="btn btn-outline hidden" onclick="cancelEdit()">Cancel Edit</button>
                </div>
            </div>

            <!-- Tab 3: All Products (UPDATED) -->
            <div id="tab3" class="tab-content hidden">
                <h2>Product Inventory</h2>
                <div id="adminProductList" class="grid"></div>
            </div>

            <!-- Tab 4: Reviews -->
            <div id="tab4" class="tab-content hidden">
                <h2>Review Moderation</h2>
                <div id="adminReviewList"></div>
            </div>

            <!-- Tab 5: Contact -->
            <div id="tab5" class="tab-content hidden">
                <h2>Contact Information</h2>
                <div class="section-card">
                    <label>Customer Support Phone Number</label>
                    <input type="text" id="phoneInput" placeholder="+1 234 567 8900">
                    <button class="btn btn-success" style="margin-top: 15px;" onclick="saveContact()">Update Phone</button>
                </div>
            </div>

            <!-- Tab 6: Orders (NEW) -->
            <div id="tab6" class="tab-content hidden">
                <h2>Incoming Orders (COD)</h2>
                <div id="ordersList">
                    <!-- Orders Injected Here -->
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRyjpnt_eClLiBLav06wRO9njaBXOWvGU",
            authDomain: "ecommlyai.firebaseapp.com",
            projectId: "ecommlyai",
            storageBucket: "ecommlyai.firebasestorage.app",
            messagingSenderId: "96539662736",
            appId: "1:96539662736:web:60dfc65784fc60c98bbb15",
            measurementId: "G-FNRQ5Z6XQ5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Auth Logic ---
        const loginBtn = document.getElementById('login-btn');
        loginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).then(res => console.log("Logged in"));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAllData();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);

        // --- UI Logic ---
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.sidebar button').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        };

        // --- Data Loading ---
        async function loadAllData() {
            // ... (Settings, Logo, Hero Images logic remains same as original)
             onSnapshot(doc(db, "settings", "general"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('webNameInput').value = data.websiteName || '';
                    document.getElementById('webNameFont').value = data.webNameFont || 'Poppins, sans-serif';
                    document.getElementById('webNameSize').value = data.webNameSize || 24;
                    document.getElementById('webNameColor').value = data.webNameColor || '#000000';
                    document.getElementById('sloganInput').value = data.slogan || '';
                    document.getElementById('sloganFont').value = data.sloganFont || 'Poppins, sans-serif';
                    document.getElementById('sloganSize').value = data.sloganSize || 16;
                    document.getElementById('sloganColor').value = data.sloganColor || '#666666';
                    document.getElementById('phoneInput').value = data.phone || '';

                    const logoArea = document.getElementById('logoPreviewArea');
                    const logoImg = document.getElementById('logoPreviewImg');
                    if (data.logoUrl) {
                        logoArea.classList.remove('hidden');
                        logoImg.src = data.logoUrl;
                    } else {
                        logoArea.classList.add('hidden');
                    }

                    const favArea = document.getElementById('faviconPreviewArea');
                    const favImg = document.getElementById('faviconPreviewImg');
                    if (data.faviconUrl) {
                        favArea.classList.remove('hidden');
                        favImg.src = data.faviconUrl;
                    } else {
                        favArea.classList.add('hidden');
                    }

                    const heroList = document.getElementById('heroList');
                    heroList.innerHTML = '';
                    if (data.heroImages && data.heroImages.length > 0) {
                        data.heroImages.forEach((url, index) => {
                            heroList.innerHTML += `
                                <div class="hero-item">
                                    <img src="${url}">
                                    <div class="delete-overlay" onclick="deleteHeroImage(${index})">√ó</div>
                                </div>
                            `;
                        });
                    }
                }
            });

            // Load Products (Including hidden ones)
            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('adminProductList');
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    let img = p.imageUrl;
                    if(p.images && p.images.length > 0) img = p.images[0];

                    const visibilityLabel = p.hidden ? "üëÅÔ∏è Hidden" : "‚úÖ Visible";
                    const stockLabel = (p.inStock === false) ? "üî¥ Out of Stock" : "üü¢ In Stock";

                    list.innerHTML += `
                        <div class="card" style="opacity: ${p.hidden ? 0.6 : 1}">
                            <img src="${img}" alt="${p.name}">
                            <h3 style="margin:0">${p.name}</h3>
                            <p style="color:var(--primary); font-weight:bold;">Rs. ${p.price}</p>
                            <div style="font-size:0.8rem; margin:5px 0;">${stockLabel} | ${visibilityLabel}</div>
                            <div style="margin-top:auto; display:flex; flex-direction:column; gap:5px;">
                                <div style="display:flex; gap:5px;">
                                    <button class="btn btn-outline btn-sm" style="flex:1" onclick="loadProductToEdit('${doc.id}')">Edit</button>
                                    <button class="btn btn-sm ${p.hidden ? 'btn-success' : 'btn-outline'}" style="flex:1" onclick="toggleVisibility('${doc.id}', ${!p.hidden})">
                                        ${p.hidden ? 'Show' : 'Hide'}
                                    </button>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct('${doc.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                });
            });

            // Load Reviews
            onSnapshot(collection(db, "reviews"), (snapshot) => {
                const list = document.getElementById('adminReviewList');
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const r = docSnap.data();
                    const isApproved = r.status === 'approved';
                    list.innerHTML += `
                        <div class="review-card" style="border-left: 5px solid ${isApproved ? 'var(--success)' : '#fbbf24'}">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>${r.name}</strong>
                                <span style="color:#fbbf24">${'‚≠ê'.repeat(r.stars)}</span>
                            </div>
                            <p style="color: #4b5563; margin: 5px 0;">"${r.comment}"</p>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <small style="color: #9ca3af; text-transform: uppercase; font-size: 0.75rem;">${r.status}</small>
                                <div>
                                    ${!isApproved ? `<button class="btn btn-success" style="padding:5px 10px;" onclick="approveReview('${docSnap.id}')">Approve</button>` : ''}
                                    <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteReview('${docSnap.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            // Load Orders (NEW)
            const oQ = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(oQ, (snapshot) => {
                const list = document.getElementById('ordersList');
                list.innerHTML = '';
                if(snapshot.empty) list.innerHTML = '<p>No orders yet.</p>';
                
                snapshot.forEach(doc => {
                    const o = doc.data();
                    const date = new Date(o.createdAt).toLocaleString();
                    const item = o.items[0]; // Assuming single item checkout
                    
                    list.innerHTML += `
                        <div class="order-row">
                            <div>
                                <h3 style="margin:0">${o.customerName}</h3>
                                <div style="color:var(--text-muted); font-size:0.9rem;">${o.customerPhone}</div>
                                <div style="font-size:0.85rem; max-width: 300px;">${o.customerAddress}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:700; color:var(--primary);">${item.name}</div>
                                <div>Rs. ${o.totalAmount}</div>
                                <small>${date}</small>
                                <div style="color:var(--success); font-weight:bold;">${o.paymentMethod}</div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- SETTINGS LOGIC (Original + Updates) ---
        window.saveGeneralSettings = async () => {
            const settingsData = {
                websiteName: document.getElementById('webNameInput').value,
                webNameFont: document.getElementById('webNameFont').value,
                webNameSize: document.getElementById('webNameSize').value,
                webNameColor: document.getElementById('webNameColor').value,

                slogan: document.getElementById('sloganInput').value,
                sloganFont: document.getElementById('sloganFont').value,
                sloganSize: document.getElementById('sloganSize').value,
                sloganColor: document.getElementById('sloganColor').value
            };
            await setDoc(doc(db, "settings", "general"), settingsData, { merge: true });
            alert("‚úÖ Settings Saved Successfully!");
        };

        window.uploadAsset = async (type) => {
            const file = document.getElementById(type + 'Upload').files[0];
            if (!file) return alert("Please select a file first.");
            const storageRef = ref(storage, `assets/${type}_${Date.now()}`); 
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            await setDoc(doc(db, "settings", "general"), { [type + 'Url']: url }, { merge: true });
            alert(type + ' updated!');
        };
        window.deleteAsset = async (type) => {
            if(!confirm(`Delete the ${type}?`)) return;
            await setDoc(doc(db, "settings", "general"), { [type + 'Url']: "" }, { merge: true });
        };
        window.uploadHeroImages = async () => {
            const files = document.getElementById('heroUpload').files;
            if (files.length === 0) return alert("Select images first.");
            const docSnap = await getDoc(doc(db, "settings", "general"));
            let currentImages = (docSnap.exists() && docSnap.data().heroImages) ? docSnap.data().heroImages : [];
            
            if (currentImages.length + files.length > 5) return alert("Max 5 images total.");

            let newUrls = [];
            for (let i = 0; i < files.length; i++) {
                const storageRef = ref(storage, `hero/hero_${Date.now()}_${i}`);
                await uploadBytes(storageRef, files[i]);
                const url = await getDownloadURL(storageRef);
                newUrls.push(url);
            }
            await setDoc(doc(db, "settings", "general"), { heroImages: [...currentImages, ...newUrls] }, { merge: true });
            alert("Hero images uploaded!");
        };
        window.deleteHeroImage = async (index) => {
            if(!confirm("Remove this image?")) return;
            const docSnap = await getDoc(doc(db, "settings", "general"));
            if (docSnap.exists()) {
                let images = docSnap.data().heroImages;
                images.splice(index, 1);
                await setDoc(doc(db, "settings", "general"), { heroImages: images }, { merge: true });
            }
        };

        // --- PRODUCT LOGIC (ADD / EDIT) ---
        window.saveProduct = async () => {
            const id = document.getElementById('editProductId').value;
            const name = document.getElementById('prodName').value;
            const price = document.getElementById('prodPrice').value;
            const slug = document.getElementById('prodSlug').value;
            const desc = document.getElementById('prodDesc').value;
            const inStock = document.getElementById('prodStock').checked;
            const btnLabel = document.getElementById('prodBtnLabel').value;
            const files = document.getElementById('prodImages').files;

            if(!name || !price) return alert("Name and Price are required.");

            // Handle Images
            let imageUrls = [];
            
            // If editing, keep old images unless explicitly replaced (logic simplified here: appending)
            // Ideally in edit mode, we might want to clear or keep.
            // For this implementation: If new files selected, upload them.
            
            if (files.length > 0) {
                 if (files.length > 5) return alert("Max 5 images allowed.");
                 for(let i=0; i<files.length; i++){
                    const storageRef = ref(storage, `products/${Date.now()}_${i}`);
                    await uploadBytes(storageRef, files[i]);
                    imageUrls.push(await getDownloadURL(storageRef));
                 }
            } else if (id) {
                // If editing and no new files, keep existing (fetch logic needed or pass in)
                // We'll rely on the existing data in Firestore merge, but wait: 
                // if we don't send 'images', merge:true keeps them. 
                // However, we need to know if we are creating.
            } else {
                return alert("Please upload at least one image for a new product.");
            }

            const data = {
                name,
                price: Number(price),
                slug: slug || name.toLowerCase().replace(/\s+/g, '-'),
                description: desc,
                inStock,
                buttonLabel: btnLabel,
                hidden: false, // Default visible
                createdAt: id ? undefined : Date.now() // Don't overwrite created date on edit
            };
            
            // Only update images if new ones were uploaded
            if(imageUrls.length > 0) {
                data.images = imageUrls;
                data.imageUrl = imageUrls[0]; // Legacy support
            }

            // Remove undefined fields
            Object.keys(data).forEach(key => data[key] === undefined && delete data[key]);

            if(id) {
                await setDoc(doc(db, "products", id), data, { merge: true });
                alert("Product Updated!");
            } else {
                await addDoc(collection(db, "products"), data);
                alert("Product Published!");
            }

            cancelEdit(); // Reset form
        };

        window.loadProductToEdit = async (id) => {
            const docSnap = await getDoc(doc(db, "products", id));
            if(!docSnap.exists()) return;
            const p = docSnap.data();

            document.getElementById('editProductId').value = id;
            document.getElementById('prodName').value = p.name;
            document.getElementById('prodPrice').value = p.price;
            document.getElementById('prodSlug').value = p.slug || '';
            document.getElementById('prodDesc').value = p.description || '';
            document.getElementById('prodBtnLabel').value = p.buttonLabel || 'See More';
            document.getElementById('prodStock').checked = (p.inStock !== false);

            document.getElementById('tab2Title').innerText = "Edit Product";
            document.getElementById('saveProductBtn').innerText = "Update Product";
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            showTab('tab2'); // Switch to tab
        };

        window.cancelEdit = () => {
            document.getElementById('editProductId').value = "";
            document.getElementById('prodName').value = "";
            document.getElementById('prodPrice').value = "";
            document.getElementById('prodSlug').value = "";
            document.getElementById('prodDesc').value = "";
            document.getElementById('prodImages').value = "";
            document.getElementById('prodStock').checked = true;
            
            document.getElementById('tab2Title').innerText = "Add New Product";
            document.getElementById('saveProductBtn').innerText = "Publish Product";
            document.getElementById('cancelEditBtn').classList.add('hidden');
        };

        window.deleteProduct = async (id) => {
            if(confirm("Delete this product?")) await deleteDoc(doc(db, "products", id));
        };

        window.toggleVisibility = async (id, status) => {
            await updateDoc(doc(db, "products", id), { hidden: status });
        };

        // --- Reviews & Contact ---
        window.approveReview = async (id) => {
            await updateDoc(doc(db, "reviews", id), { status: 'approved' });
        };
        window.deleteReview = async (id) => {
            await deleteDoc(doc(db, "reviews", id));
        };
        window.saveContact = async () => {
            const phone = document.getElementById('phoneInput').value;
            await setDoc(doc(db, "settings", "general"), { phone: phone }, { merge: true });
            alert("Phone Updated");
        };

    </script>
</body>
</html>
